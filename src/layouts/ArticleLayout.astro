---
import Navigation from '../components/Navigation';
import Footer from '../components/Footer';
import BaseHead from '../components/BaseHead.astro';
import Icon from '../components/Icon';
import ArticleNavigation from '../components/ArticleNavigation';
import TableOfContents from '../components/TableOfContents';
import { SITE_TITLE, AUTHOR_NAME, SITE_URL } from '../consts';

const { title, subtitle, icon, iconColor, readingTime, tags, category, mediumUrl, githubUrl, prevArticle, nextArticle, groupName, headings = [], date, description } = Astro.props;

// Create article URL
const articleUrl = new URL(Astro.url.pathname, Astro.site).toString();

// Build JSON-LD structured data
const jsonLd = {
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": title,
	"description": subtitle || description || title,
	"author": {
		"@type": "Person",
		"name": AUTHOR_NAME,
		"url": SITE_URL
	},
	"datePublished": date?.toISOString(),
	"dateModified": date?.toISOString(),
	"publisher": {
		"@type": "Person",
		"name": AUTHOR_NAME,
		"url": SITE_URL
	},
	"mainEntityOfPage": {
		"@type": "WebPage",
		"@id": articleUrl
	},
	"keywords": tags?.join(', '),
	"articleSection": category,
	...(githubUrl && { "codeRepository": githubUrl })
};

// Build breadcrumb structured data
const breadcrumbJsonLd = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"name": "Home",
			"item": SITE_URL
		},
		{
			"@type": "ListItem",
			"position": 2,
			"name": "Articles",
			"item": `${SITE_URL}/articles`
		},
		{
			"@type": "ListItem",
			"position": 3,
			"name": title,
			"item": articleUrl
		}
	]
};
---

<!doctype html>
<html lang="en" class="scroll-smooth overflow-x-hidden">
	<head>
		<BaseHead 
			title={`${title} - ${SITE_TITLE}`} 
			description={subtitle || title} 
			article={{
				publishedTime: date,
				section: category,
				tags: tags,
			}}
		/>
		
		<!-- JSON-LD Structured Data -->
		<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
		<script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
		
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
		<style>
			/* Mermaid diagram styling for img-based rendering */
			.prose img[id^="mermaid-"],
			.prose picture {
				background-color: rgba(255, 255, 255, 0.9);
				border-radius: 0.5rem;
				padding: 1.5rem;
				margin: 2rem 0;
				width: 100%;
				height: auto;
				display: block;
				border: 1px solid rgba(0, 0, 0, 0.1);
			}

			.dark .prose img[id^="mermaid-"],
			.dark .prose picture {
				background-color: rgba(255, 255, 255, 0.05);
				border-color: rgba(255, 255, 255, 0.1);
			}

			.prose picture img {
				margin: 0;
				padding: 0;
				background-color: transparent;
				border: none;
			}

			.prose .mermaid-wrapper {
				position: relative;
				background-color: rgba(255, 255, 255, 0.9);
				border-radius: 0.5rem;
				padding: 1.5rem;
				margin: 2rem 0;
				border: 1px solid rgba(0, 0, 0, 0.1);
			}

			.dark .prose .mermaid-wrapper {
				background-color: rgba(255, 255, 255, 0.05);
				border-color: rgba(255, 255, 255, 0.1);
			}

			.prose .mermaid-wrapper img[id^="mermaid-"],
			.prose .mermaid-wrapper picture {
				background-color: transparent;
				padding: 0;
				margin: 0;
				border: none;
			}

			/* Mermaid expand button */
			.mermaid-expand-btn {
				position: absolute;
				top: 0.75rem;
				right: 0.75rem;
				padding: 0.5rem;
				background-color: rgba(0, 0, 0, 0.1);
				border: 1px solid rgba(0, 0, 0, 0.2);
				border-radius: 0.5rem;
				color: #404040;
				cursor: pointer;
				opacity: 0;
				transition: opacity 0.2s, background-color 0.2s;
				z-index: 10;
			}

			.dark .mermaid-expand-btn {
				background-color: rgba(255, 255, 255, 0.1);
				border-color: rgba(255, 255, 255, 0.2);
				color: #e5e5e5;
			}

			.mermaid-wrapper:hover .mermaid-expand-btn {
				opacity: 1;
			}

			.mermaid-expand-btn:hover {
				background-color: rgba(0, 0, 0, 0.2);
			}

			.dark .mermaid-expand-btn:hover {
				background-color: rgba(255, 255, 255, 0.2);
			}

			/* Dialog styling */
			#mermaid-dialog {
				background-color: rgba(255, 255, 255, 0.95);
				border: none;
				max-width: 100vw;
				max-height: 100vh;
				width: 100vw;
				height: 100vh;
				padding: 0;
				margin: 0;
			}

			.dark #mermaid-dialog {
				background-color: rgba(10, 10, 10, 0.95);
			}

			#mermaid-dialog::backdrop {
				background-color: rgba(0, 0, 0, 0.9);
				backdrop-filter: blur(4px);
			}

			.dialog-controls {
				position: fixed;
				top: 1rem;
				right: 1rem;
				display: flex;
				gap: 0.5rem;
				z-index: 100;
			}

			.dialog-zoom-level {
				position: fixed;
				top: 1rem;
				left: 1rem;
				padding: 0.5rem 0.75rem;
				background-color: rgba(0, 0, 0, 0.1);
				color: #404040;
				border-radius: 0.5rem;
				border: 1px solid rgba(0, 0, 0, 0.2);
				font-size: 0.875rem;
				font-family: monospace;
				z-index: 100;
			}

			.dark .dialog-zoom-level {
				background-color: rgba(255, 255, 255, 0.1);
				color: white;
				border-color: rgba(255, 255, 255, 0.2);
			}

			.dialog-content-wrapper {
				width: 100%;
				height: 100%;
				overflow: auto;
				padding: 0;
				display: grid;
				place-items: center;
			}

			.dialog-content {
				transition: transform 0.2s ease;
				transform-origin: center center;
				width: 100%;
				height: 100%;
				padding: 6rem 2rem 2rem 2rem;
				display: grid;
				place-items: center;
			}

			.dialog-content svg {
				max-width: 100%;
				max-height: 100%;
				width: auto;
				height: auto;
				object-fit: contain;
			}

			/* Math formula styling */
			.prose .katex {
				font-size: 1.1em;
			}

			.prose .katex-display {
				margin: 2rem 0;
				overflow-x: auto;
				overflow-y: hidden;
			}

			.prose .katex-display > .katex {
				text-align: center;
			}
		</style>
	</head>
	<body class="bg-white dark:bg-[#0a0a0a] text-gray-800 dark:text-gray-300 font-sans selection:bg-gray-200 dark:selection:bg-white/20 overflow-x-hidden">
        <Navigation client:load />

        <main class="max-w-3xl mx-auto px-6 pt-32 pb-20">
             <article id="article-content" class="prose dark:prose-invert prose-neutral max-w-none">
                <div class="mb-12 not-prose">
                    {icon && (
                        <div class="flex items-center gap-4 mb-6">
                            <div class={`p-2 bg-gray-100 dark:bg-white/5 rounded-lg border border-gray-300 dark:border-white/10 w-12 h-12 ${iconColor}`}>
                                <Icon name={icon} />
                            </div>
                             <div class="flex flex-col">
                                <span class="text-xs font-mono text-gray-500 uppercase tracking-wider">{category}</span>
                                <span class="text-sm text-gray-600 dark:text-gray-400">{readingTime}</span>
                            </div>
                        </div>
                    )}

                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4 tracking-tight">{title}</h1>
                    {subtitle && <p class="text-xl text-gray-600 dark:text-gray-400 leading-relaxed">{subtitle}</p>}

                    {tags && (
                         <div class="flex gap-2 mt-6">
                            {tags.map((tag: string) => (
                                <span class="text-[10px] font-mono uppercase tracking-wider bg-gray-100 dark:bg-white/5 text-gray-600 dark:text-gray-400 px-2 py-1 rounded border border-gray-300 dark:border-white/10">
                                    {tag}
                                </span>
                            ))}
                         </div>
                    )}
                </div>
                <slot />
                
                {(mediumUrl || githubUrl) && (
                    <div class="mt-12 pt-8 border-t border-gray-300 dark:border-white/10 flex flex-wrap gap-4">
                        {githubUrl && (
                            <a href={githubUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors group">
                                <div class="p-2 bg-gray-100 dark:bg-white/5 rounded-lg border border-gray-300 dark:border-white/10 group-hover:border-gray-400 dark:group-hover:border-white/20 transition-colors">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                    </svg>
                                </div>
                                <span class="font-mono text-sm">View on GitHub</span>
                            </a>
                        )}
                        {mediumUrl && (
                            <a href={mediumUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors group">
                                <div class="p-2 bg-gray-100 dark:bg-white/5 rounded-lg border border-gray-300 dark:border-white/10 group-hover:border-gray-400 dark:group-hover:border-white/20 transition-colors">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M13.54 12a6.8 6.8 0 01-6.77 6.82A6.8 6.8 0 010 12a6.8 6.8 0 016.77-6.82A6.8 6.8 0 0113.54 12zM20.96 12c0 3.54-1.51 6.42-3.38 6.42-1.87 0-3.39-2.88-3.39-6.42s1.52-6.42 3.39-6.42 3.38 2.88 3.38 6.42M24 12c0 3.17-.53 5.75-1.19 5.75-.66 0-1.19-2.58-1.19-5.75s.53-5.75 1.19-5.75C23.47 6.25 24 8.83 24 12z"/>
                                    </svg>
                                </div>
                                <span class="font-mono text-sm">Read this article on Medium</span>
                            </a>
                        )}
                    </div>
                )}
             </article>
             
             <ArticleNavigation 
                client:load
                prevArticle={prevArticle}
                nextArticle={nextArticle}
                groupName={groupName}
             />
        </main>

        <Footer />

		<!-- Table of Contents -->
		<TableOfContents client:load headings={headings} />

		<!-- Mermaid Dialog Modal -->
		<dialog id="mermaid-dialog">
			<div class="dialog-controls">
				<button id="zoom-out-btn" class="p-3 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 transition-colors" title="Zoom out">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"/>
						<path d="m21 21-4.3-4.3"/>
						<path d="M8 11h6"/>
					</svg>
				</button>
				<button id="zoom-in-btn" class="p-3 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 transition-colors" title="Zoom in">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"/>
						<path d="m21 21-4.3-4.3"/>
						<path d="M11 8v6"/>
						<path d="M8 11h6"/>
					</svg>
				</button>
				<button id="close-dialog-btn" class="p-3 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 transition-colors" title="Close">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M18 6 6 18"/>
						<path d="m6 6 12 12"/>
					</svg>
				</button>
			</div>
			<div class="dialog-zoom-level" id="zoom-level">100%</div>
			<div class="dialog-content-wrapper">
				<div class="dialog-content" id="dialog-content"></div>
			</div>
		</dialog>

		<script>
			let currentScale = 1;
			const dialog = document.getElementById('mermaid-dialog') as HTMLDialogElement;
			const dialogContent = document.getElementById('dialog-content');
			const zoomLevel = document.getElementById('zoom-level');

			// Handle mermaid theme switching
			function updateMermaidTheme() {
				const isDark = document.documentElement.classList.contains('dark');
				const pictures = document.querySelectorAll('picture');
				
				pictures.forEach((picture) => {
					const darkSource = picture.querySelector('source[media*="prefers-color-scheme: dark"]') as HTMLSourceElement;
					const lightImg = picture.querySelector('img') as HTMLImageElement;
					
					if (darkSource && lightImg) {
						// Store original sources if not already stored
						if (!lightImg.hasAttribute('data-light-src')) {
							lightImg.setAttribute('data-light-src', lightImg.src);
						}
						if (!lightImg.hasAttribute('data-dark-src')) {
							const darkSrc = darkSource.getAttribute('srcset');
							if (darkSrc) {
								lightImg.setAttribute('data-dark-src', darkSrc);
							}
						}

						// Switch based on theme
						if (isDark) {
							const darkSrc = lightImg.getAttribute('data-dark-src');
							if (darkSrc) {
								lightImg.src = darkSrc;
							}
						} else {
							const lightSrc = lightImg.getAttribute('data-light-src');
							if (lightSrc) {
								lightImg.src = lightSrc;
							}
						}
					}
				});
			}

			// Listen for theme changes
			window.addEventListener('theme-changed', updateMermaidTheme);
			
			// Run on load
			document.addEventListener('DOMContentLoaded', () => {
				updateMermaidTheme();
			});

			function setupMermaidButtons() {
				// Find all picture elements that contain mermaid diagrams
				const mermaidPictures = document.querySelectorAll('picture');
				
				if (mermaidPictures.length === 0) return;

				mermaidPictures.forEach((picture) => {
					// Check if this picture contains a mermaid diagram
					const darkSource = picture.querySelector('source[id^="mermaid-"]');
					if (!darkSource) return;

					// Skip if already wrapped
					if (picture.parentElement?.classList.contains('mermaid-wrapper')) return;

					// Create wrapper
					const wrapper = document.createElement('div');
					wrapper.className = 'mermaid-wrapper';
					picture.parentElement?.insertBefore(wrapper, picture);
					wrapper.appendChild(picture);

					// Create expand button
					const expandBtn = document.createElement('button');
					expandBtn.innerHTML = `
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
						</svg>
					`;
					expandBtn.className = 'mermaid-expand-btn';
					expandBtn.title = 'Expand diagram';
					expandBtn.onclick = () => {
						const img = picture.querySelector('img') as HTMLImageElement;
						if (!img) return;

						const src = img.src;
						if (src.startsWith('data:image/svg+xml') && dialogContent && dialog) {
							const svgData = decodeURIComponent(src.split(',')[1]);
							dialogContent.innerHTML = svgData;
							currentScale = 1;
							updateZoom();
							dialog.showModal();
						}
					};

					wrapper.appendChild(expandBtn);
				});
			}

			function updateZoom() {
				if (dialogContent) {
					dialogContent.style.transform = `scale(${currentScale})`;
				}
				if (zoomLevel) {
					zoomLevel.textContent = `${Math.round(currentScale * 100)}%`;
				}
			}

			// Setup event listeners
			document.addEventListener('DOMContentLoaded', () => {
				setupMermaidButtons();

				const zoomInBtn = document.getElementById('zoom-in-btn');
				const zoomOutBtn = document.getElementById('zoom-out-btn');
				const closeBtn = document.getElementById('close-dialog-btn');

				zoomInBtn?.addEventListener('click', () => {
					currentScale = Math.min(currentScale + 0.2, 3);
					updateZoom();
				});

				zoomOutBtn?.addEventListener('click', () => {
					currentScale = Math.max(currentScale - 0.2, 0.5);
					updateZoom();
				});

				closeBtn?.addEventListener('click', () => {
					dialog?.close();
				});

				// Dialog also closes with ESC key (built-in feature)
			});
		</script>
    </body>
</html>
